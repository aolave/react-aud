(function(e,t,n){e.widget("epilgrim.sessionTimeoutHandler",{options:{title:"Session Timeout",message:"Your session is about to expire.",keepAliveUrl:"keepAlive.php",retrieveTimeLeftUrl:"retrieveTimeLeft.php",redirUrl:false,logoutUrl:"logout.php",defaultSessionTime:false,warnWhenLeft:3e5,checkTimeBeforeRedirect:true,errorGettingSessionTimeLeft:"There was an error retrieving session information from the server. Session could be timed out",modalId:"sessionTimeout-dialog",logOutNow:function(e,n){t.location=n.plugin.options.logoutUrl},redirectNow:function(e,n){t.location=n.plugin.options.redirUrl},stayConnected:function(t,n){n.plugin.modal.modal("hide");n.plugin._trigger("getSessionTimeLeft",null,{plugin:n.plugin,updateSession:true,callback:e.proxy(function(e){this.initializeTimers(e)},n.plugin)})},getSessionTimeLeft:function(t,n){var r=n.updateSession?n.plugin.options.keepAliveUrl:n.plugin.options.retrieveTimeLeftUrl;var i=n.plugin;e.ajax({context:i,dataType:"json",url:r,success:function(e){var t=e.response*1e3;n.callback.call(i,t);if(t>this.options.warnWhenLeft){this.modal.modal("hide")}},error:function(e){if(e.status==401){location.reload();return}location.reload()}})}},_create:function(){this.dialogTimer=null;this.redirectTimer=null;if(this.options.redirUrl==false){this.options.redirUrl=this.options.logoutUrl}this._createModal();this.initializeTimers(this.options.defaultSessionTime)},_createModal:function(){var e=this;var t='<div class="modal hide fade" id='+this.options.modalId+">"+'<div class="modal-header"><h3 style="font-size:16px">'+this.options.title+"</h3></div>"+'<div class="modal-body"><p style="padding:10px;text-align:center;font-size:20px"><span class="icon-moon-clock" style="font-size:16px"></span>'+this.options.message+"</p>"+'<div><button class="btn btn-danger btn-logout">'+__tr("Log Out Now")+"</button>"+'<button class="btn btn-primary btn-stayconnected pull-right">'+__tr("Stay Connected")+"</button></div>"+"</div>"+"</div>";this.modal=jQuery(t);this.modal.on("click",".btn-logout",function(){e._trigger("logOutNow",null,{plugin:e})}).on("click",".btn-stayconnected",function(){e._trigger("stayConnected",null,{plugin:e})});this.modal.appendTo(this.element)},_destroy:function(){this.modal.remove()},_dialogTimer:function(t,n){switch(t){case"start":this.dialogTimer=setTimeout(e.proxy(this._dialogHandler,this),n);break;case"stop":clearTimeout(this.dialogTimer);break;case"restart":this._dialogTimer("stop");this._dialogTimer("start",n);break}},_redirectTimer:function(t,n){switch(t){case"start":this.redirectTimer=setTimeout(e.proxy(this._redirectHandler,this),n);break;case"stop":clearTimeout(this.redirectTimer);break;case"restart":this._redirectTimer("stop");this._redirectTimer("start",n);break}},_dialogHandler:function(){this.modal.modal("show")},_redirectHandler:function(){if(this.options.checkTimeBeforeRedirect){this._trigger("getSessionTimeLeft",null,{plugin:this,updateSession:false,callback:function(e){if(e<=0){this._trigger("redirectNow",null,{plugin:this})}else{this.initializeTimers(e)}}})}else{this._trigger("redirectNow",null,{plugin:this})}},_setTimers:function(e){var t;t=this.dialogTimer===null?"start":"restart";this._dialogTimer(t,e-this.options.warnWhenLeft);t=this.redirTimer===null?"start":"restart";this._redirectTimer(t,e)},initializeTimers:function(e){if(e===false){this._trigger("getSessionTimeLeft",null,{plugin:this,updateSession:false,callback:this._setTimers})}else{this._setTimers(e)}}})})(jQuery,window)